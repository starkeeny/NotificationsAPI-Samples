<!doctype html>
<html lang="en">

<head>
    <title>Notification Sample</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script>
        var registeredServiceWorker = null;
        var button;

        function manageUI() {
            button.disabled = !(Notification.permission === 'granted' && registeredServiceWorker);
        }

        function simpleNotification() {
            navigator.serviceWorker.showNotification('Arrrrrrrrrr', {
                body: `Is this alrrrrrrrrright?`,
                requireInteraction: true
            });
        }

        window.addEventListener('load', function () {
            button = document.getElementsByTagName('button')[0];

            if (!('serviceWorker' in navigator)) {
                alert("This browser does not support service worker");
                return
            }
            if (!("Notification" in window)) {
                alert("This browser does not support desktop notification");
                return;
            }

            manageUI();

            navigator.serviceWorker.getRegistrations().then(registrations => {
                var i = 0;
                for (i = 0; i < registrations.length; i++) {
                    if (registrations[i].scope.toLowerCase().startsWith('https://starkeeny.github.io/NotificationsAPI-Samples/'.toLowerCase())) {
                        registeredServiceWorker = registrations[i];
                        console.log('registration found', registeredServiceWorker);
                        manageUI();
                    }
                }
            });

            if (!registeredServiceWorker) {
                navigator.serviceWorker.register('service-worker.js')
                    .then(function (registration) {
                        registeredServiceWorker = registration;
                        manageUI();
                        registeredServiceWorker.addEventListener('message', function (event) {
                            console.log('Received a message from service worker: ' + JSON.stringify(event.data));
                        });
                    })
                    .catch(function (err) {
                        alert('ERROR: Unable to register service worker. "' + err + '"');
                    });
            }

            // Otherwise, we need to ask the user for permission
            if (Notification.permission !== 'denied' && Notification.permission !== 'granted') {
                Notification.requestPermission(function (permission) {
                    manageUI();
                    console.log('permission requested. New permission outputted:', permission)
                });
            }
        });
    </script>
</head>

<body>
    <button onclick="simpleNotification()">test</button>
</body>

</html>

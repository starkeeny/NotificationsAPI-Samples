<!doctype html>
<html lang="en">
<head>
    <title>Notification Sample</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script>
        var registeredServiceWorker = null;
        var button;

        function manageUI() {
            button.disabled = !(Notification.permission === 'granted' && registeredServiceWorker);
        }

        function simpleNotification() {
            registeredServiceWorker.showNotification('Arrrrrrrrrr', {
                body: `Is this alrrrrrrrrright?`,
                requireInteraction: true
            });
        }

        window.addEventListener('load', function () {
            button = document.getElementsByTagName('button')[0];

            if (!('serviceWorker' in navigator)) {
                alert("This browser does not support service worker");
                return
            }
            if (!("Notification" in window)) {
                alert("This browser does not support desktop notification");
                return;
            }

            navigator.serviceWorker.getRegistrations()
                .then(registrations => {
                    var i = 0;
                    for (i = 0; i < registrations.length; i++) {
                        if (registrations[i].scope.toLowerCase().startsWith('https://starkeeny.github.io/NotificationsAPI-Samples/'.toLowerCase())) {
                            registeredServiceWorker = registrations[i];
                            console.log('registration found', registeredServiceWorker);
                        }
                    }
                })
                .then(value => {
                    if (!registeredServiceWorker) {
                        navigator.serviceWorker.register('service-worker.js')
                            .then(function (registration) {
                                registeredServiceWorker = registration;
                                console.log('new registration performed', registeredServiceWorker);
                            })
                            .catch(function (err) {
                                alert('ERROR: Unable to register service worker. "' + err + '"');
                            });
                    }
                })
                .then(value => {
                    manageUI();
                    registeredServiceWorker.addEventListener('message', function (event) {
                        console.log('Received a message from service worker: ' + JSON.stringify(event.data));
                    });
                });

            if (Notification.permission !== 'denied' && Notification.permission !== 'granted') {
                Notification.requestPermission(function (permission) {
                    manageUI();
                    console.log('notification permission requested. New permission outputted:', permission)
                });
            } else {
                console.log('notification permission is:', Notification.permission);
            }
        });
    </script>
</head>

<body>
    <button onclick="simpleNotification()">test</button>
</body>

</html>
